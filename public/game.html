<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello phaser!</title>
        <script src="phaser.min.js"></script>
        <script src="enemyCar.js"></script>
        <script src="player.js"></script>
    </head>
    <body>

      <script src="/socket.io/socket.io.js"></script>
      <script>
        var socket = io.connect('http://SERVERIP');
        // Add a connect listener
        socket.on('connect', function() {
          console.log('Client has connected to the server!');
        });
        // Add a connect listener
        socket.on('message', function(data) {
          console.log('Received a message from the server!', data);
        });
        // Add a disconnect listener
        socket.on('disconnect', function() {
          console.log('The client has disconnected!');
        });
      </script>

    <script type="text/javascript">

    window.onload = function() {
        function preload() {
            game.load.spritesheet('player_1', 'assets/player_1.png', 42, 42);
            game.load.image('bullet_1', 'assets/bullet_1.png');
            game.load.spritesheet('monster_1', 'assets/monster1.png', 48, 64);
            game.load.spritesheet('monster_car', 'assets/monster_car.png', 40, 40);
        }

        var account_id = 1;
        var group_player;
        var group_enemy;
        var group_player_bullet;
        var group_enemy_bullet;
        var keyLeft;
        var keyRight;
        var keyUpward;
        var keyDownward;
        var bulletTime = 0;

        var Enemy = function(game, x, y, type) {
            Phaser.Sprite.call( this, game, x, y, 'monster_1' );

            this.anchor.setTo( 0.5, 0.5 );

            this.game.physics.enable(this, Phaser.Physics.ARCADE);

            // Define constants that affect motion
            this.SPEED = 100; // missile speed pixels/second
            this.TURN_RATE = 5; // turn rate in degrees/frame
            // this.WOBBLE_LIMIT = 15; // degrees
            // this.WOBBLE_SPEED = 250; // milliseconds
            // this.SMOKE_LIFETIME = 3000; // milliseconds
            // this.AVOID_DISTANCE = 30; // pixels
        };

        // Missiles are a type of Phaser.Sprite
        Enemy.prototype = Object.create(Phaser.Sprite.prototype);
        Enemy.prototype.constructor = Enemy;
        Enemy.prototype.update = function() {
        };

        var game = new Phaser.Game(800, 600, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update, render: render });

        function create() {
            group_player = game.add.group();
            group_player.enableBody = true;
            group_player.physicsBodyType = Phaser.Physics.ARCADE;

            group_enemy = game.add.group();
            group_enemy.enableBody = true;
            group_enemy.physicsBodyType = Phaser.Physics.ARCADE;

            group_player_bullet = game.add.group();
            group_player_bullet.enableBody = true;
            group_player_bullet.physicsBodyType = Phaser.Physics.ARCADE;
            group_player_bullet.createMultiple(30, 'bullet_1');
            group_player_bullet.setAll('anchor.x', 0.5);
            group_player_bullet.setAll('anchor.y', 1);
            group_player_bullet.setAll('outOfBoundsKill', true);
            group_player_bullet.setAll('checkWorldBounds', true);

            group_enemy_bullet = game.add.group();
            group_enemy_bullet.enableBody = true;
            group_enemy_bullet.physicsBodyType = Phaser.Physics.ARCADE;
            group_enemy_bullet.createMultiple(30, 'bullet_1');
            group_enemy_bullet.setAll('anchor.x', 0.5);
            group_enemy_bullet.setAll('anchor.y', 1);
            group_enemy_bullet.setAll('outOfBoundsKill', true);
            group_enemy_bullet.setAll('checkWorldBounds', true);

            // //  Our bullet group
            // bullets = game.add.group();
            // bullets.enableBody = true;
            // bullets.physicsBodyType = Phaser.Physics.ARCADE;
            // bullets.createMultiple(30, 'bullet');
            // bullets.setAll('anchor.x', 0.5);
            // bullets.setAll('anchor.y', 1);
            // bullets.setAll('outOfBoundsKill', true);
            // bullets.setAll('checkWorldBounds', true);

            // // The enemy's bullets
            // enemyBullets = game.add.group();
            // enemyBullets.enableBody = true;
            // enemyBullets.physicsBodyType = Phaser.Physics.ARCADE;
            // enemyBullets.createMultiple(30, 'enemyBullet');
            // enemyBullets.setAll('anchor.x', 0.5);
            // enemyBullets.setAll('anchor.y', 1);
            // enemyBullets.setAll('outOfBoundsKill', true);
            // enemyBullets.setAll('checkWorldBounds', true);

            createPlayer( 400, 500, 1 );
            game.physics.startSystem(Phaser.Physics.ARCADE);

            //  The hero!

            keyLeft = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
            keyRight = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
            keyUpward = game.input.keyboard.addKey(Phaser.Keyboard.UP);
            keyDownward = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);

            createAliens();
            group_enemy.x = 100;
            group_enemy.y = 50;
        }

        function createPlayer(x, y, id) {
            var player = new Player(game, x, y, id);
            group_player.add(player);
        }

        function createAliens(x, y, type) {
            var alien = new Enemy_Car(game, x, y, type);
            group_enemy.add(alien);
            alien.anchor.setTo(0.5, 0.5);
            alien.animations.add('walk', [ 0, 1 ], 5, true);
            alien.play('walk');
            //alien.body.moves = false;
            alien.revive();
        }

        function getPlayerWithId( id ) {
            var targetPlayer;
            group_player.forEach(function(player) {
                if ( player.id == id ) {
                    targetPlayer = player;
                    return;
                }
            });
            return targetPlayer;
        }

        function fireBullet() {
            group_player.forEach(function(player) {
            // console.log( "fireBullet" );
            //  To avoid them being allowed to fire too fast we set a time limit
            if (game.time.now > bulletTime) {
                //  Grab the first bullet we can from the pool
                bullet = group_player_bullet.getFirstExists(false);
                if (bullet) {
                    //  And fire it
                    bullet.reset(player.x, player.y + 8);
                    bullet.body.velocity.y = -400;
                    bulletTime = game.time.now + 1000;
                }
            }
            });
        }

        function update() {
            fireBullet();

            var player = getPlayerWithId(account_id);

            if ( player ) {
                //  Reset the player, then check for movement keys
                player.body.velocity.setTo(0, 0);

                if (keyLeft.isDown)
                {
                    player.body.velocity.x = -200;
                }
                else if (keyRight.isDown)
                {
                    player.body.velocity.x = 200;
                }

                if (keyUpward.isDown)
                {
                    player.body.velocity.y = -200;
                }
                else if (keyDownward.isDown)
                {
                    player.body.velocity.y = 200;
                }
            }
        }

        function render() {

            // for (var i = 0; i < aliens.length; i++)
            // {
            //     game.debug.body(aliens.children[i]);
            // }

        }
    };

    </script>

    </body>
</html>
