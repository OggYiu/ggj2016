<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello phaser!</title>
        <script src="phaser.min.js"></script>
        <script src="enemyTracker.js"></script>
        <script src="enemyCar.js"></script>
        <script src="player.js"></script>
        <script src="Glow.js"></script>
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {
        function preload() {
            game.load.spritesheet('player_1', 'assets/player_1.png', 42, 42);
            game.load.spritesheet('player_2', 'assets/player_2.png', 42, 42);
            game.load.spritesheet('player_3', 'assets/player_3.png', 42, 42);
            game.load.image('bullet_1', 'assets/bullet_1.png');
            game.load.spritesheet('monster_1', 'assets/monster1.png', 48, 64);
            game.load.spritesheet('monster_car', 'assets/monster_car.png', 40, 40);
        }
        var account_id = 1;
        var group_player;
        var group_enemy;
        var group_player_bullet;
        var group_enemy_bullet;
        var keyLeft;
        var keyRight;
        var keyUpward;
        var keyDownward;
        var bulletTime = 0;
        var magicTriangle;
        var graphics;

        var game = new Phaser.Game(800, 600, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update, render: render });
        game.myScreenWidth = 800;
        game.myScreenHeight = 600;
        function create() {
            group_player = game.add.group();
            group_player.enableBody = true;
            group_player.physicsBodyType = Phaser.Physics.ARCADE;

            group_enemy = game.add.group();
            group_enemy.enableBody = true;
            group_enemy.physicsBodyType = Phaser.Physics.ARCADE;

            group_player_bullet = game.add.group();
            group_player_bullet.enableBody = true;
            group_player_bullet.physicsBodyType = Phaser.Physics.ARCADE;
            group_player_bullet.createMultiple(30, 'bullet_1');
            group_player_bullet.setAll('anchor.x', 0.5);
            group_player_bullet.setAll('anchor.y', 1);
            group_player_bullet.setAll('outOfBoundsKill', true);
            group_player_bullet.setAll('checkWorldBounds', true);

            group_enemy_bullet = game.add.group();
            group_enemy_bullet.enableBody = true;
            group_enemy_bullet.physicsBodyType = Phaser.Physics.ARCADE;
            group_enemy_bullet.createMultiple(30, 'bullet_1');
            group_enemy_bullet.setAll('anchor.x', 0.5);
            group_enemy_bullet.setAll('anchor.y', 1);
            group_enemy_bullet.setAll('outOfBoundsKill', true);
            group_enemy_bullet.setAll('checkWorldBounds', true);

            // //  Our bullet group
            // bullets = game.add.group();
            // bullets.enableBody = true;
            // bullets.physicsBodyType = Phaser.Physics.ARCADE;
            // bullets.createMultiple(30, 'bullet');
            // bullets.setAll('anchor.x', 0.5);
            // bullets.setAll('anchor.y', 1);
            // bullets.setAll('outOfBoundsKill', true);
            // bullets.setAll('checkWorldBounds', true);

            // // The enemy's bullets
            // enemyBullets = game.add.group();
            // enemyBullets.enableBody = true;
            // enemyBullets.physicsBodyType = Phaser.Physics.ARCADE;
            // enemyBullets.createMultiple(30, 'enemyBullet');
            // enemyBullets.setAll('anchor.x', 0.5);
            // enemyBullets.setAll('anchor.y', 1);
            // enemyBullets.setAll('outOfBoundsKill', true);
            // enemyBullets.setAll('checkWorldBounds', true);

            game.physics.startSystem(Phaser.Physics.ARCADE);

            //  The hero!

            keyLeft = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
            keyRight = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
            keyUpward = game.input.keyboard.addKey(Phaser.Keyboard.UP);
            keyDownward = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);

            createPlayer( game, 400, 500, 1 );
            createPlayer( game, 500, 400, 2 );
            createPlayer( game, 300, 200, 3 );

            createEnemyTracker(game, 10, 10);
            createEnemyCar(game, 100, 0);
            createEnemyCar(game, 100, 1);
            createEnemyCar(game, 100, 2);
            createEnemyCar(game, 100, 3);

            // group_enemy.x = 100;
            // group_enemy.y = 50;

            //  You can also create an empty Polygon:
            magicTriangle = new Phaser.Polygon();
            graphics = game.add.graphics(0, 0);

            //connectServer();
        }

        function onEnemyPlayerOverlay( enemy, player ) {
            //console.log( "overlapped!, enemy : " + enemy.entityType + ", player : " + player.entityType );
        }

        function createPlayer(game, x, y, id) {
            var player = new Player(game, x, y, id);
            group_player.add(player);

            var filter = new Phaser.Filter(game, null, glowFragmentSrc);
            filter.setResolution(800, 600);
            player.filters = [ filter ];
        }

        function createEnemyTracker( game, x, y ) {
            var alien = new Enemy_Tracker(game, x, y, getPlayerWithId(1));
            group_enemy.add(alien);
        }

        function createEnemyCar(game, pos, type) {
            var alien = new Enemy_Car(game, pos, type);
            group_enemy.add(alien);
        }

        function getPlayerWithId( id ) {
            var targetPlayer;
            group_player.forEach(function(player) {
                if ( player.id == id ) {
                    targetPlayer = player;
                    return;
                }
            });
            return targetPlayer;
        }

        function fireBullet() {
            group_player.forEach(function(player) {
            // console.log( "fireBullet" );
            //  To avoid them being allowed to fire too fast we set a time limit
            if (game.time.now > bulletTime) {
                //  Grab the first bullet we can from the pool
                bullet = group_player_bullet.getFirstExists(false);
                if (bullet) {
                    //  And fire it
                    bullet.reset(player.x, player.y + 8);
                    bullet.body.velocity.y = -400;
                    bulletTime = game.time.now + 1000;
                }
            }
            });
        }

        function update() {
            fireBullet();

            var player = getPlayerWithId(account_id);

            if ( player ) {
                //  Reset the player, then check for movement keys
                player.body.velocity.setTo(0, 0);

                if (keyLeft.isDown)
                {
                    player.body.velocity.x = -200;
                    updatePlayerPosition(player);
                }
                else if (keyRight.isDown)
                {
                    player.body.velocity.x = 200;
                    updatePlayerPosition(player);
                }

                if (keyUpward.isDown)
                {
                    player.body.velocity.y = -200;
                    updatePlayerPosition(player);
                }
                else if (keyDownward.isDown)
                {
                    player.body.velocity.y = 200;
                    updatePlayerPosition(player);
                }
            }

            game.physics.arcade.overlap(group_enemy, group_player, onEnemyPlayerOverlay, null, this);
        }

        function updateMagicCircle() {
            if ( group_player.children.length < 3 ) {
                return;
            }
            var player1 = getPlayerWithId(1);
            var player2 = getPlayerWithId(2);
            var player3 = getPlayerWithId(3); 

            //  And then populate it via setTo, using any combination of values as above
            magicTriangle.setTo([ new Phaser.Point(player1.x, player1.y), new Phaser.Point(player2.x, player2.y), new Phaser.Point(player3.x, player3.y)]);
            graphics.clear();
            graphics.beginFill(0xFF33ff, 0.3);
            graphics.drawPolygon(magicTriangle.points);
            graphics.endFill();
        }

        function render() {
            updateMagicCircle();
            // for (var i = 0; i < aliens.length; i++)
            // {
            //     game.debug.body(aliens.children[i]);
            // }
        }

        var socket = null;

        function updatePlayerPosition(player)
        {
            var json = {"id":account_id, "posX":player.x, "posY":player.y, "status":'ALIVE'};
            if ( socket ) {
                socket.emit('update_player', json);
            }
        }

        function connectServer()
        {
          function UpdateRemotePlayer(player)
          {
            var remotePlayer = getPlayerWithId(player.id);
            remotePlayer.x = player.posX;
            remotePlayer.y = player.posY;
          }

          function NewPlayer(player)
          {
            createPlayer(game, player.posX, player.posY, player.id);
            account_id = player.id;
          }

          function NewRemotePlayer(player)
          {
            createPlayer(game, player.posX, player.posY, player.id);
          }

          socket = io.connect('http://SERVERIP');

          // Add a connect listener
          socket.on('connect', function() {
            console.log('Client has connected to the server!');
          });

          socket.on('new_player', function(player) {
            NewPlayer(player);
          });

          socket.on('new_remote_player', function(player) {
            NewRemotePlayer(player);
          });

          socket.on('update_player', function(player) {
            UpdateRemotePlayer(player);
          });

          // Add a disconnect listener
          socket.on('disconnect', function() {
            console.log('The client has disconnected!');
          });
        }
    };

    </script>

    </body>
</html>
